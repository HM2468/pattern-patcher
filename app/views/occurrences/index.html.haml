-# frozen_string_literal: true
-# app/views/occurrences/index.html.haml

- current_status = (@status.presence || "unprocessed").to_s
- status_options = [["Unprocessed (#{@unprocessed_count})", "unprocessed"], ["Processed (#{@processed_count})", "processed"], ["Ignored (#{@ignored_count})", "ignored"]]
- filter_type = (params[:filter_type].presence || (params[:path_filter].present? ? "file_path" : "lexeme_text")).to_s
- input_value = (filter_type == "file_path" ? params[:path_filter].to_s : params[:text_filter].to_s)
- scan_run_id = params[:scan_run_id].presence
- pagination_options = { status: params[:status], text_filter: params[:text_filter], path_filter: params[:path_filter], filter_type: params[:filter_type], scan_run_id: scan_run_id }.compact
- search_param_name = (filter_type == "file_path" ? "path_filter" : "text_filter")

%div{ class: "h-full overflow-hidden" }
  %div#occurrences_panel{ class: "flex flex-col h-full overflow-hidden rounded-2xl" }

    -# ===== Fixed Header (NOT scroll) =====
    %div{ class: "bg-indigo-100 text-gray-600 border-b border-gray-100 mx-5 rounded-2xl" }
      %div{ class: "px-6 py-3 flex items-center justify-left gap-3" }
        %div{ class: "flex flex-col items-start text-left leading-tight min-w-0" }
          %div{ class: "text-lg font-semibold text-gray-900" } Occurrences

        -# ===== Status dropdown =====
        = form_with url: occurrences_path, method: :get, local: true, data: { turbo: false }, class: "inline-flex items-center" do
          = hidden_field_tag :page, nil
          = hidden_field_tag :text_filter, params[:text_filter]
          = hidden_field_tag :path_filter, params[:path_filter]
          = hidden_field_tag :filter_type, params[:filter_type]
          = hidden_field_tag :scan_run_id, scan_run_id if scan_run_id.present?
          %div{ class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 shadow-sm ring-1 ring-gray-200 hover:ring-gray-300 focus-within:ring-2 focus-within:ring-indigo-500" }
            %span{ class: "font-mono text-xs text-gray-600" }
            = select_tag :status,
              options_for_select(status_options, current_status),
              class: "font-mono text-xs text-gray-900 bg-transparent border-0 p-0 pr-6 focus:ring-0 focus:outline-none cursor-pointer",
              onchange: "this.form.submit()"

        -# ===== Combined filter dropdown + input (single control) =====
        %div{ class: "inline-flex items-center" }
          %div{ class: "inline-flex items-center rounded-md bg-white shadow-sm ring-1 ring-gray-200 hover:ring-gray-300 focus-within:ring-2 focus-within:ring-indigo-500 overflow-hidden" }
            = form_with url: occurrences_path, method: :get, local: true, data: { turbo: false }, class: "inline-flex items-center" do
              = hidden_field_tag :status, params[:status]
              = hidden_field_tag :page, nil
              = hidden_field_tag :scan_run_id, scan_run_id if scan_run_id.present?
              = hidden_field_tag :text_filter, (filter_type == "lexeme_text" ? input_value : "")
              = hidden_field_tag :path_filter, (filter_type == "file_path" ? input_value : "")

              = select_tag :filter_type,
                options_for_select([["Lexeme content", "lexeme_text"], ["File path", "file_path"]], filter_type),
                class: "h-full font-mono text-xs text-gray-900 bg-transparent border-0 px-1 py-1 focus:ring-0 focus:outline-none cursor-pointer border-r border-gray-200",
                onchange: "var f=this.form; var v=this.value; var raw=f.dataset.searchValue||''; if(v==='lexeme_text'){f.querySelector('input[name=path_filter]').value=''; f.querySelector('input[name=text_filter]').value=raw;} else {f.querySelector('input[name=text_filter]').value=''; f.querySelector('input[name=path_filter]').value=raw;} f.submit();"

            %input{
              type: "text",
              value: input_value,
              placeholder: (filter_type == "file_path" ? "Search file path..." : "Search lexeme content..."),
              class: "w-[22rem] px-3 py-1 font-mono text-xs text-gray-900 bg-transparent focus:outline-none",
              data: {
                controller: "live-search",
                "live-search-delay-value": 600,
                "live-search-url-template-value": occurrences_path(status: params[:status], filter_type: filter_type, scan_run_id: scan_run_id).to_s,
                "live-search-param-name-value": search_param_name,
                "live-search-frame-id-value": "repo_right",
                "live-search-min-length-value": 0
              },
              oninput: "var form=this.previousElementSibling; if(form){form.dataset.searchValue=this.value||''}"
            }

    -# ===== Scroll area: ONLY body scrolls =====
    %div#occurrences_body_scroll{ class: "pp-scroll-gutter-stable flex-1 overflow-y-auto" }
      %div{ class: "px-6 py-4 space-y-4" }
        - if !defined?(@occurrences) || @occurrences.blank?
          %div#occurrences_empty_state
            .rounded-2xl.bg-gray-50.p-8.shadow-sm
              %div{ class: "text-sm text-gray-600" }
                No Records found.
        - else
          - @occurrences.each do |occ|
            - diff = @diffs_by_occurrence_id[occ.id]
            - next if diff.nil?
            = render "diff", diff: diff, occ: occ

    -# ===== Fixed Footer Pagination =====
    %div{ class: "sticky bottom-0" }
      - if defined?(@occurrences) && @occurrences.respond_to?(:current_page) && @occurrences.any?
        = render "shared/pagination", collection: @occurrences, options: pagination_options