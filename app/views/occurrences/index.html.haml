-# app/views/occurrences/index.html.haml

%div{ class: "max-w-6xl mx-auto h-[85vh] overflow-hidden" }
  %div#scan_run_occurrences_panel{
    class: "repo-files-panel flex flex-col h-full overflow-hidden rounded-2xl bg-white shadow-sm"
  }

    -# ===== Fixed Header (NOT scroll) =====
    -if @scan_run.present?
      %div{ class: "text-gray-600 border-b border-gray-200" }
        %div{ class: "px-6 py-3 flex items-center justify-between gap-3" }
          %div{ class: "flex flex-col items-start text-left leading-tight min-w-0" }
            %div{ class: "text-sm font-mono text-gray-600" }
              = "\##{@scan_run.id} Scan Matches"
          %div{ class: "shrink-0" }
            - repo_id = @scan_run.repository_snapshot.repository_id
            = link_to scan_runs_path(repository_id: repo_id),
              class: "icon-button",
              data: tooltip_data(tip: "Back") do
              = svg_icon("arrow-uturn-left", class_name: "w-6 h-6")
    -else
      %div{ class: "text-gray-600 border-b border-gray-200" }
        %div{ class: "px-6 py-3 flex items-center justify-between gap-3" }
          %div{ class: "flex flex-col items-start text-left leading-tight min-w-0" }
            %div{ class: "text-sm font-mono text-gray-600" }
              = "All Matches"
          %div{ class: "shrink-0" }
            = link_to occurrences_path,
              class: "icon-button",
              data: tooltip_data(tip: "Back") do
              = svg_icon("arrow-uturn-left", class_name: "w-6 h-6")

    -# ===== Scroll area: ONLY content scrolls =====
    -# NOTE: add pp-scroll-gutter-stable to keep width aligned with header when scrollbar appears
    %div#scan_run_occurrences_body_scroll{ class: "pp-scroll-gutter-stable flex-1 overflow-y-auto" }
      %div{ class: "px-6 py-4 space-y-4" }
        - if @occurrences.blank?
          %div{ class: "rounded-xl bg-gray-50 p-6 text-gray-600" }
            No matches found.
        - else
          - @occurrences.each do |occ|
            %div{ class: "pp-diff" }
              %div{ class: "pp-file-head" }= occ.repository_file&.path.to_s
              %div{ class: "pp-row" }
                %div{ class: "pp-lno" }= occ.line_at
                %div{ class: "pp-code" }= occ.highlighted_origin_context.html_safe

    -# ===== Fixed Footer Pagination =====
    %div{ class: "repo-files-pagination sticky bottom-0 z-10 bg-white border-t border-gray-200" }
      %div{ class: "px-6 py-3" }
        = render "shared/pagination",
          collection: @occurrences,
          options: { scan_run_id: @scan_run&.id }.compact

:css
  /* Keep header/body width aligned even when body has a vertical scrollbar */
  .pp-scroll-gutter-stable { scrollbar-gutter: stable; }

  /* container like GitHub diff block */
  .pp-diff {
    border: 1px solid rgb(208, 215, 222);
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
  }

  .pp-file-head {
    background: rgb(246, 248, 250);
    border-bottom: 1px solid rgb(208, 215, 222);
    padding: 3px 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    color: rgb(31, 35, 40);
  }

  .pp-row {
    display: grid;
    grid-template-columns: 30px 1fr;
    align-items: stretch;
    border-top: 1px solid rgb(240, 246, 252);
  }
  .pp-row:first-child { border-top: none; }

  .pp-lno {
    background: rgb(240, 246, 252);
    color: rgb(99, 110, 123);
    text-align: right;

    padding: 6px 6px;
    display: flex;
    align-items: center;

    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 16px;
    user-select: none;

    border-right: 1px solid rgb(208, 215, 222);
  }

  /* code cell: no wrapping, scroll horizontally when too long */
  .pp-code {
    background: rgb(230, 255, 237);
    color: rgb(31, 35, 40);

    padding: 6px 10px;

    display: block;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: pre;
    word-break: normal;

    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 16px;

    -webkit-overflow-scrolling: touch;
  }

  /* highlight span inside pp-code */
  .ppmatchhi {
    display: inline;
    line-height: inherit;
    background: rgb(172, 242, 190);
    color: rgb(0, 0, 0);
    border-radius: 4px;
    padding: 0 2px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }