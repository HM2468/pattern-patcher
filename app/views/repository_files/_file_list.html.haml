-# app/views/repository_files/_file_list.html.haml

- if @repositories.empty?
  %div{ class: "p-6 text-gray-700" } No repositories found.
- elsif @current_repo.nil?
  %div{ class: "p-6 text-gray-700" } Please select a repository.
- elsif @repository_files.empty?
  %div{ class: "p-6 text-gray-700" } Please import files or check whether the repository is empty.
- else
  %div#repo_files_panel{ class: "flex-1 overflow-auto rounded-2xl bg-white shadow-sm", data: { repo_id: @current_repo.id } }
    %table#repo_files_table{ class: "w-full text-sm table-fixed" }
      %thead{ class: "bg-indigo-100 text-gray-600 sticky top-0 z-10" }
        %tr
          %th{ class: "px-4 py-3 font-semibold" }
            %div#repo_files_toolbar{ class: "flex items-center gap-3" }
              %div{ class: "flex items-center gap-2 shrink-0" }
                %input#check_all{ type: "checkbox" }
                %span Select All

              %div{ class: "flex-1 px-2" }
                %input#path_filter_input{
                  type: "text",
                  value: @path_filter,
                  placeholder: "Search by path prefix... e.g. app/models/",
                  class: "w-full text-sm rounded px-3 py-2 bg-white",
                  autocomplete: "off"
                }
                %div#bulk_hint{ class: "text-xs text-gray-500 mt-1" }
                  Select files to enable bulk ops.

              %div{ class: "ml-auto flex items-center gap-2 shrink-0" }
                %button#bulk_delete{ type: "button", class: "button-danger" } Delete
                %button#bulk_scan{ type: "button", class: "button-primary" } Scan

      %tbody#repo_files_tbody{ class: "divide-y divide-gray-300" }
        - @repository_files.each do |f|
          %tr{ class: "hover:bg-indigo-50/60 transition", data: { file_id: f.id } }
            %td{ class: "px-4 py-3" }
              %div{ class: "flex items-start gap-3" }
                %input{
                  id: "file_check_#{f.id}",
                  type: "checkbox",
                  value: f.id,
                  data: { file_check: "1" },
                  class: "mt-1"
                }
                %label{ for: "file_check_#{f.id}", class: "flex-1 min-w-0 cursor-pointer" }
                  %div{ class: "truncate font-mono text-sm text-gray-900", title: f.path }
                    = f.path

  = form_with url: bulk_delete_repository_files_path, method: :post, local: true,
    html: { id: "bulk_delete_form", class: "hidden" } do
    = hidden_field_tag :repository_id, @current_repo.id, id: "bulk_delete_repository_id"
    %div#bulk_delete_file_ids

  = form_with url: batch_scan_scan_runs_path, method: :post, local: true,
    html: { id: "bulk_scan_form", class: "hidden" } do
    = hidden_field_tag :repository_id, @current_repo.id, id: "bulk_scan_repository_id"
    %div#bulk_scan_file_ids

%div#repo_files_pagination{ class: "bottom-pagination" }
  = render "shared/pagination",
    collection: @repository_files,
    options: { repository_id: @current_repo.id, path_filter: @path_filter }.compact


:javascript
  (function() {
    function initRepoFilesPage() {
      const panel = document.getElementById("repo_files_panel");
      if (!panel) return;

      // ✅ 防重复：每次 turbo:load / DOMContentLoaded 只初始化一次
      if (panel.dataset.initialized === "1") return;
      panel.dataset.initialized = "1";

      const repoId = panel.dataset.repoId;

      const checkAll = document.getElementById("check_all");
      const hint = document.getElementById("bulk_hint");

      const bulkDeleteBtn = document.getElementById("bulk_delete");
      const bulkScanBtn   = document.getElementById("bulk_scan");

      const deleteForm = document.getElementById("bulk_delete_form");
      const scanForm   = document.getElementById("bulk_scan_form");
      const deleteIdsBox = document.getElementById("bulk_delete_file_ids");
      const scanIdsBox   = document.getElementById("bulk_scan_file_ids");

      const searchInput = document.getElementById("path_filter_input");

      // ✅ 统一从 data attribute 找 checkbox，避免 class 被覆盖
      const checks = () => Array.from(document.querySelectorAll('input[data-file-check="1"]'));

      function selectedIds() {
        return checks().filter(x => x.checked).map(x => x.value);
      }

      function setButtonsEnabled(enabled) {
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !enabled;
        if (bulkScanBtn) bulkScanBtn.disabled = !enabled;
      }

      function updateHintAndButtons() {
        const count = selectedIds().length;
        if (hint) {
          hint.textContent = count > 0 ? `Selected: ${count}` : "Select files to enable bulk ops.";
        }
        setButtonsEnabled(count > 0);
      }

      function syncCheckAllState() {
        if (!checkAll) return;
        const all = checks();
        checkAll.checked = (all.length > 0 && all.every(x => x.checked));
      }

      function fillHiddenIds(container, ids) {
        if (!container) return;
        container.innerHTML = "";
        ids.forEach(id => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "file_ids[]";
          input.value = id;
          container.appendChild(input);
        });
      }

      function confirmAndSubmit(form, idsBox, actionLabel) {
        if (!form || !idsBox) return;

        const ids = selectedIds();
        if (ids.length === 0) return;

        const ok = window.confirm(`${actionLabel} ${ids.length} file(s)?`);
        if (!ok) return;

        fillHiddenIds(idsBox, ids);
        form.submit();
      }

      // --- Select All ---
      if (checkAll) {
        checkAll.addEventListener("change", () => {
          checks().forEach(c => { c.checked = checkAll.checked; });
          updateHintAndButtons();
        });
      }

      // --- Single checkbox toggle (delegate) ---
      // ✅ 绑定在 panel 上，避免全局 document 重复监听
      panel.addEventListener("change", (e) => {
        if (e.target && e.target.matches && e.target.matches('input[data-file-check="1"]')) {
          syncCheckAllState();
          updateHintAndButtons();
        }
      });

      // --- Buttons ---
      setButtonsEnabled(false);
      updateHintAndButtons();

      if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener("click", () => {
          confirmAndSubmit(deleteForm, deleteIdsBox, "Delete");
        });
      }

      if (bulkScanBtn) {
        bulkScanBtn.addEventListener("click", () => {
          confirmAndSubmit(scanForm, scanIdsBox, "Scan");
        });
      }

      // --- Live search (debounced) ---
      if (searchInput) {
        let timer = null;

        function runSearch() {
          const value = (searchInput.value || "").trim();
          const params = new URLSearchParams();

          if (repoId) params.set("repository_id", repoId);
          if (value.length > 0) params.set("path_filter", value);

          // 搜索时回到第一页：不设置 page
          const url = `${window.location.pathname}?${params.toString()}`;
          window.location.assign(url);
        }

        searchInput.addEventListener("input", () => {
          if (timer) clearTimeout(timer);
          timer = setTimeout(runSearch, 250);
        });
      }
    }

    document.addEventListener("turbo:load", initRepoFilesPage);
    document.addEventListener("DOMContentLoaded", initRepoFilesPage);
  })();