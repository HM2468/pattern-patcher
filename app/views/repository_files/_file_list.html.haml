-# frozen_string_literal: true
-# app/views/repository_files/_file_list.html.haml

- repository = local_assigns.fetch(:repository, nil) || @repository
- repository_files = local_assigns.fetch(:repository_files, nil) || @repository_files
- path_filter = local_assigns.fetch(:path_filter, nil) || @path_filter
- scan_hint_message = local_assigns.fetch(:scan_hint_message, nil) || @scan_hint_message

- if repository.nil?
  %div{ class: "p-6 text-gray-700" }
    Please select a repository.
- elsif repository_files.blank? || repository_files.empty?
  %div{ class: "p-6 text-gray-700" }
    Please import files or check whether the repository is empty.
- else
  %div#repo_files_panel{
    class: "repo-files-panel flex flex-col h-full overflow-hidden rounded-2xl bg-white shadow-sm",
    data: {
      controller: "repo-files",
      repo_files_repo_id_value: repository.id,
      repo_files_scan_hint_message_value: scan_hint_message
    }
  }

    %div{ class: "text-lg font-semibold text-gray-900 px-6 py-3" }
      = "#{@repository.name} files"

    -# ===== Fixed Header (NOT scroll) =====
    %table#repo_files_table_head{ class: "w-full text-sm table-fixed repo-files-head" }
      %thead{ class: "bg-indigo-100 text-gray-600" }
        %tr
          %th{ class: "px-4 py-3 font-semibold" }
            %div#repo_files_toolbar{ class: "flex items-center gap-3" }
              %div{ class: "flex items-start gap-2 shrink-0" }
                %input#check_all{ type: "checkbox", class: "mt-1 scale-150", data: { repo_files_target: "checkAll" } }

                %div{ class: "flex flex-col items-start text-left leading-tight" }
                  %span{ class: "text-sm" } Select All
                  %div#bulk_hint{ class: "text-xs text-gray-500", data: { repo_files_target: "hint" } }
                    200/page

              %div{ class: "flex-1 px-2" }
                %input#path_filter_input{
                  type: "text",
                  value: path_filter,
                  placeholder: "prefix matching filter (live search)",
                  class: "w-full text-sm rounded px-3 py-2 bg-white",
                  autocomplete: "off",
                  data: {
                    controller: "live-search",
                    live_search_delay_value: 1200,
                    live_search_url_template_value: "/repository_files?repository_id=__REPO_ID__",
                    live_search_param_name_value: "path_filter",
                    live_search_repo_id_value: repository.id,
                    live_search_frame_id_value: "repo_right",
                    live_search_min_length_value: 2
                  }
                }

              %div{ class: "ml-auto flex items-center gap-2 shrink-0" }
                %button#bulk_scan{
                  type: "button",
                  class: "button-primary",
                  disabled: true,
                  data: { action: "repo-files#onBulkScanClick", repo_files_target: "bulkScanBtn" }
                } Scan

                %button#bulk_delete{
                  type: "button",
                  class: "button-danger",
                  disabled: true,
                  data: { action: "repo-files#onBulkDeleteClick", repo_files_target: "bulkDeleteBtn" }
                } Delete

    -# ===== Scroll area: ONLY tbody scrolls =====
    %div#repo_files_body_scroll{ class: "repo-files-body-scroll flex-1 overflow-y-auto" }
      %table#repo_files_table_body{ class: "w-full text-sm table-fixed" }
        %tbody#repo_files_tbody{
          class: "divide-y divide-gray-300",
          data: { action: "change->repo-files#onTbodyChange" }
        }
          - repository_files.each do |f|
            %tr{ class: "hover:bg-indigo-50/60 transition", data: { file_id: f.id } }
              %td{ class: "px-4 py-3" }
                %div{ class: "flex items-start gap-3" }
                  %input{
                    id: "file_check_#{f.id}",
                    type: "checkbox",
                    value: f.id,
                    data: { file_check: "1", repo_files_target: "fileCheck" },
                    class: "mt-1 scale-150"
                  }
                  %label{ for: "file_check_#{f.id}", class: "flex-1 min-w-0 cursor-pointer" }
                    %div{ class: "truncate font-mono text-sm text-gray-900", title: f.path }
                      = f.path

    -# ===== hidden forms MUST be inside #repo_files_panel so repo-files controller can find targets =====
    %div{ class: "hidden" }
      = form_with url: scan_runs_path, method: :post, local: true do
        = hidden_field_tag :repository_id, repository.id, id: "bulk_scan_repository_id"
        %div#bulk_scan_file_ids{ data: { repo_files_target: "scanIdsBox" } }
        %button#bulk_scan_trigger{
          type: "submit",
          onclick: "return window.PopConfirmLog.open(event, this)",
          data: {
            confirm_title: "Scan files",
            confirm_message_html: scan_hint_message,
            confirm_confirm_label: "Scan",
            confirm_cancel_label: "Cancel"
          },
          class: "button-primary",
          data: { repo_files_target: "scanTrigger" }
        } Scan

    %div{ class: "hidden" }
      = form_with url: bulk_delete_repository_files_path, method: :post, local: true do
        = hidden_field_tag :repository_id, repository.id
        %div#bulk_delete_file_ids{ data: { repo_files_target: "deleteIdsBox" } }
        %button#bulk_delete_trigger{
          type: "submit",
          onclick: "return window.PopConfirmLog.open(event, this)",
          class: "button-danger",
          data: {
            repo_files_target: "deleteTrigger",
            confirm_title: "Delete files",
            confirm_message_html: "Delete selected files? This cannot be undone.",
            confirm_confirm_label: "Delete",
            confirm_cancel_label: "Cancel"
          }
        } Delete

    -# ===== Fixed Footer Pagination =====
    %div#repo_files_pagination{
      class: "repo-files-pagination sticky bottom-0 bg-white border-t border-gray-200"
    }
      = render "shared/pagination",
        collection: repository_files,
        options: { repository_id: repository&.id, path_filter: path_filter }.compact