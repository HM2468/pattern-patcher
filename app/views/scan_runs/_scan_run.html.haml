-# app/views/scan_runs/_scan_run.html.haml

- d = scan_run_display(scan_run)
- p = scan_run_progress_display(progress)

%div{
  id: "scan_run_#{scan_run.id}",
  class: "rounded-2xl bg-gray-50 p-4 shadow-sm space-y-3",
  data: { "scan-run-id": scan_run.id }
}
  %div{ class: "flex items-start justify-between gap-4" }
    %div{ class: "min-w-0 space-y-2" }
      -# Row 1: #ID + repo + sha
      %div{ class: "flex items-center gap-2 min-w-0" }
        %div{ class: "font-mono text-sm font-semibold text-gray-900" }= "##{scan_run.id}"
        %div{ class: "text-gray-400" } ·
        %div{ class: "font-semibold text-gray-900 truncate" }= d[:repo_name]
        %div{ class: "text-gray-400" } ·
        %div{ class: "font-mono text-sm text-gray-700" }= d[:sha_short]

      -# Row 2: started/finished
      %div{ class: "flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-600" }
        %div
          %span{ class: "font-medium" } Started:
          %span{ class: "font-mono" }= scan_run.started_at ? l(scan_run.started_at, format: :short) : "-"
        %div
          %span{ class: "font-medium" } Finished:
          %span{ class: "font-mono" }= scan_run.finished_at ? l(scan_run.finished_at, format: :short) : "-"

      -# Row 3: pattern snapshot (optional but requested)
      - if scan_run.pattern_snapshot.present?
        %div{ class: "text-xs text-gray-600" }
          %div{ class: "text-sm text-gray-700" }
            %span{ class: "font-medium" } Scanned with:
            %span= d[:lp_name]
          %div{ class: "mt-1 rounded-lg border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800 break-all" }
            = scan_run.pattern_snapshot

      -# Prominent nav links (Matches / Files)
      %div{ class: "flex flex-wrap items-center gap-3 pt-1" }
        = link_to scanned_occurrences_scan_run_path(scan_run),
          class: "inline-flex items-center gap-2 rounded-lg bg-white px-3 py-1.5 text-sm font-medium text-indigo-700 shadow-sm ring-1 ring-indigo-200 hover:bg-indigo-50 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
          title: "View scanned matches" do
          %span Matches
          %span{ class: "font-mono", data: { scan_runs_target: "occCount" } }= d[:occ_count]
          %span{ class: "text-indigo-400" } →

        = link_to scanned_files_scan_run_path(scan_run),
          class: "inline-flex items-center gap-2 rounded-lg bg-white px-3 py-1.5 text-sm font-medium text-emerald-700 shadow-sm ring-1 ring-emerald-200 hover:bg-emerald-50 hover:ring-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-500",
          title: "View scanned files" do
          %span Files
          %span{ class: "text-emerald-400" } →

    %div{ class: "flex items-center gap-2 flex-shrink-0" }
      -# Retry button (placeholder URL)
      = button_to "Retry",
        "#",
        method: :post,
        form: { class: "inline-flex" },
        class: "button-secondary"

      = button_to "Delete",
        scan_run_path(scan_run),
        method: :delete,
        form: { class: "inline-flex" },
        onclick: "return window.PopConfirmLog.open(event, this)",
        data: { confirm_title: "Delete scan run", confirm_message: "Delete this scan run? This cannot be undone." },
        class: "button-danger"

  -# Progress header (phase + counters) — counters become a link to scanned_files
  %div{ class: "flex items-center justify-between text-xs text-gray-600" }
    %div{ class: "flex items-center gap-2" }
      %div{ class: "font-medium", data: { scan_runs_target: "phase" } }= p[:phase]

    = link_to scanned_files_scan_run_path(scan_run),
      class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 font-mono text-xs text-gray-800 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50 hover:ring-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
      title: "Open scanned files (progress details)" do
      %span{ data: { scan_runs_target: "done" } }= p[:done]
      %span /
      %span{ data: { scan_runs_target: "total" } }= p[:total]
      %span{ class: "text-gray-400" } (failed:
      %span{ data: { scan_runs_target: "failed" } }= p[:failed]
      %span{ class: "text-gray-400" } )
      %span{ class: "text-gray-400" } →

  -# Progress bar
  %div{ class: "w-full h-3 rounded-full bg-gray-200 overflow-hidden" }
    %div{
      class: "h-3 #{d[:bar_class]}",
      style: "width: #{p[:pct]}%",
      data: { scan_runs_target: "bar" }
    }

  -# Optional error message (only when present)
  - if p[:err_msg].present?
    %div{ class: "text-sm text-red-700", data: { scan_runs_target: "error" } }
      = p[:err_msg]
  - else
    %div{ class: "text-sm text-red-700 hidden", data: { scan_runs_target: "error" } }