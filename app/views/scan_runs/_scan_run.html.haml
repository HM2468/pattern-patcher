-# app/views/scan_runs/_scan_run.html.haml

- d = scan_run_display(scan_run)
- p = scan_run_progress_display(progress)

%div{
  id: "scan_run_#{scan_run.id}",
  class: "rounded-2xl bg-gray-50 p-4 shadow-sm space-y-3",
  data: { "scan-run-id": scan_run.id }
}
  %div{ class: "flex items-start justify-between gap-4" }
    %div{ class: "min-w-0 space-y-1" }
      %div{ class: "flex items-center gap-2 min-w-0" }
        %div{ class: "font-semibold text-gray-900 truncate" }= d[:repo_name]
        %div{ class: "text-gray-400" } Â·
        %div{ class: "font-mono text-sm text-gray-700" }= d[:sha_short]

      %div{ class: "text-sm text-gray-700" }
        %span{ class: "font-medium" } Pattern:
        %span= d[:lp_name]

      %div{ class: "text-sm text-gray-700" }
        %span{ class: "font-medium" } Matches:
        %span{ class: "font-mono", data: { scan_runs_target: "occCount" } }= d[:occ_count]

    %div{ class: "flex items-center gap-2 flex-shrink-0" }
      = button_to "Delete",
        scan_run_path(scan_run),
        method: :delete,
        form: { class: "inline-flex" },
        onclick: "return window.PopConfirmLog.open(event, this)",
        data: { confirm_title: "Delete scan run", confirm_message: "Delete this scan run? This cannot be undone." },
        class: "button-danger"

  -# Progress header (phase + counters)
  %div{ class: "flex items-center justify-between text-xs text-gray-600" }
    %div
      %span{ class: "font-medium" } Phase:
      %span{ class: "font-mono", data: { scan_runs_target: "phase" } }= p[:phase]
    %div{ class: "font-mono" }
      %span{ data: { scan_runs_target: "done" } }= p[:done]
      %span /
      %span{ data: { scan_runs_target: "total" } }= p[:total]
      %span{ class: "text-gray-400" } (failed:
      %span{ data: { scan_runs_target: "failed" } }= p[:failed]
      %span{ class: "text-gray-400" } )

  -# Progress bar
  %div{ class: "w-full h-3 rounded-full bg-gray-200 overflow-hidden" }
    %div{
      class: "h-3 #{d[:bar_class]}",
      style: "width: #{p[:pct]}%",
      data: { scan_runs_target: "bar" }
    }

  -# Optional error message (only when present)
  - if p[:err_msg].present?
    %div{ class: "text-sm text-red-700", data: { scan_runs_target: "error" } }
      = p[:err_msg]
  - else
    %div{ class: "text-sm text-red-700 hidden", data: { scan_runs_target: "error" } }