-# app/views/scan_runs/_scan_run.html.haml

- d = scan_run_display(scan_run)
- p = scan_run_progress_display(progress)
- started_at = scan_run.started_at ? l(scan_run.started_at, format: :short) : "-"

%div{
  id: "scan_run_#{scan_run.id}",
  class: "rounded-2xl border border-indigo-200 bg-gray-100 shadow-sm overflow-hidden p-5",
  data: { "scan-run-id": scan_run.id }
}
  %div{ class: "flex items-start justify-between gap-4" }
    %div{ class: "min-w-0 space-y-3" }
      %div{ class: "bg-indigo-100 flex items-center gap-2 min-w-0 rounded-lg px-3 py-2" }
        %div{ class: "font-mono text-sm font-semibold text-gray-900" }
          = "##{scan_run.id} -> #{started_at}"

      -# 3 rows × 2 columns (title bold, value smaller, both left aligned)
      %div{ class: "grid grid-cols-[160px_1fr] gap-x-3 gap-y-2 text-gray-700" }
        %div{ class: "text-sm font-semibold text-gray-800" } Scanned mode:
        %div{ class: "text-xs font-mono text-gray-700 break-words" }= d[:scan_mode]

        %div{ class: "text-sm font-semibold text-gray-800" } Pattern name:
        %div{ class: "text-xs font-mono text-gray-700 break-words" }= d[:pattern_name]

        %div{ class: "text-sm font-semibold text-gray-800" } Scanned regexp:
        %div{ class: "text-xs font-mono text-gray-700 break-words" }= d[:regexp]

    %div{ class: "flex items-center gap-2 flex-shrink-0" }
      = form_with url: scan_run_path(scan_run),
        method: :delete,
        data: { turbo_frame: "repo_right", controller: "tooltip", tooltip_text_value: "Delete scan", tooltip_placement_value: "bottom" },
        html: { class: "inline-flex" } do
        %button{
          type: "submit",
          class: "icon-button",
          onclick: "return window.PopConfirmLog.open(event, this)",
          data: { confirm_title: "Delete scan run", confirm_message: "Delete this scan run? This cannot be undone." }
        }
          = svg_icon("trash", class_name: "w-6 h-6")

  -# add spacing between meta and progress section
  %div{ class: "p-3 flex items-center justify-between text-xs text-gray-600" }
    %div{ class: "flex items-center gap-2" }
      %div{ class: "text-sm font-medium", data: { scan_runs_target: "phase" } }= p[:phase]

    = link_to occurrences_path(scan_run_id: scan_run.id),
      class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 font-mono text-xs text-gray-800 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
      title: "View scanned matches",
      data: { turbo_prefetch: false } do
      %span Matches
      %span{ class: "font-mono", data: { scan_runs_target: "occCount" } }= d[:occ_count]
      %span{ class: "text-indigo-400" } →

    = link_to scanned_files_scan_run_path(scan_run),
      class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 font-mono text-xs text-gray-800 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50 hover:ring-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
      title: "Open scanned files (progress details)",
      data: { turbo_prefetch: false } do
      %span{ data: { scan_runs_target: "done" } }= p[:done]
      %span /
      %span{ data: { scan_runs_target: "total" } }= p[:total]
      %span{ class: "text-gray-400" } (failed:
      %span{ data: { scan_runs_target: "failed" } }= p[:failed]
      %span{ class: "text-gray-400" } )
      %span{ class: "text-gray-400" } →

  %div{ class: "w-full h-3 rounded-full bg-gray-200 overflow-hidden" }
    %div{ class: "h-3 bg-indigo-500", style: "width: #{p[:pct]}%", data: { scan_runs_target: "bar" } }

  - if p[:err_msg].present?
    %div{ class: "text-sm text-red-700", data: { scan_runs_target: "error" } }= p[:err_msg]
  - else
    %div{ class: "text-sm text-red-700 hidden", data: { scan_runs_target: "error" } }