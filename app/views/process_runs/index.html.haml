-# frozen_string_literal: true
-# app/views/process_runs/index.html.haml

%div{ class: "max-w-6xl mx-auto p-6 space-y-4" }
  %div{ class: "flex items-center justify-between" }
    %div{ class: "text-lg font-semibold" } Process Runs
    %div{ class: "text-sm text-gray-600" }
      Total:
      %span{ class: "font-mono" }= @process_runs.total_count

  %div{
    class: "space-y-3",
    data: {
      controller: "process-runs",
      process_runs_channel_value: "ProcessRunsChannel"
    }
  }
    - @process_runs.each do |pr|
      - p = (@progress_by_id[pr.id] || {}).with_indifferent_access

      - status = pr.status
      - total = p[:total].to_i
      - succeeded = p[:succeeded].to_i
      - failed = p[:failed].to_i
      - processed = p[:processed].to_i
      - percent = p[:percent].to_f
      - batches_total = p[:batches_total].to_i
      - batches_done = p[:batches_done].to_i
      - occ_revc = p[:occ_revc].to_i

      %div{
        id: "process_run_#{pr.id}",
        class: "rounded-2xl bg-gray-50 p-4 shadow-sm space-y-3",
        data: {
          "process-run-id": pr.id,
          "process-run-status": status
        }
      }
        %div{ class: "flex items-start justify-between gap-4" }
          %div{ class: "min-w-0 space-y-2" }
            -# Row 1: #ID + processor + created_at
            %div{ class: "flex items-center gap-2 min-w-0" }
              %div{ class: "font-mono text-sm font-semibold text-gray-900" }= "##{pr.id}"
              %div{ class: "text-gray-400" } ·
              %div{ class: "font-semibold text-gray-900 truncate" }= pr.lexeme_processor&.name || pr.lexeme_processor&.entrypoint || "-"
              %div{ class: "text-gray-400" } ·
              %div{ class: "text-xs text-gray-600" }= l(pr.created_at, format: :short)

            -# Row 2: status + batches
            %div{ class: "flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-600" }
              %div
                %span{ class: "font-medium" } Status:
                %span{ class: "font-mono", data: { process_runs_target: "status" } }= status
              %div
                %span{ class: "font-medium" } Batches:
                %span{ class: "font-mono", data: { process_runs_target: "batchesDone" } }= batches_done
                %span /
                %span{ class: "font-mono", data: { process_runs_target: "batchesTotal" } }= batches_total

            -# Prominent nav links (Merged counters / Reviews) — style copied from scan_runs/_scan_run
            %div{ class: "flex flex-wrap items-center gap-3 pt-1" }
              = link_to "",
                class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 font-mono text-xs text-gray-800 shadow-sm ring-1 ring-gray-200 hover:bg-gray-50 hover:ring-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
                title: "Open progress details" do
                %span{ data: { process_runs_target: "processed" } }= processed
                %span /
                %span{ data: { process_runs_target: "total" } }= total
                %span{ class: "text-gray-400" } (failed:
                %span{ data: { process_runs_target: "failed" } }= failed
                %span{ class: "text-gray-400" } )
                %span{ class: "text-gray-400" } →

              = link_to "",
                class: "inline-flex items-center gap-2 rounded-lg bg-white px-3 py-1.5 text-sm font-medium text-indigo-700 shadow-sm ring-1 ring-indigo-200 hover:bg-indigo-50 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500",
                title: "New review rows (OccurrenceReviewResult)" do
                %span Reviews
                %span{ class: "font-mono", data: { process_runs_target: "occRevc" } }= occ_revc
                %span{ class: "text-indigo-400" } →

          %div{ class: "flex items-center gap-2 flex-shrink-0" }
            = button_to "Delete",
              process_run_path(pr),
              method: :delete,
              form: { class: "inline-flex" },
              onclick: "return window.PopConfirmLog.open(event, this)",
              data: { confirm_title: "Delete process run", confirm_message: "Delete this process run? This cannot be undone." },
              class: "button-danger"

        -# Progress header (phase + percent)
        %div{ class: "flex items-center justify-between text-xs text-gray-600" }
          %div{ class: "flex items-center gap-2" }
            %div{ class: "font-medium" }
              Progress:
              %span{ class: "font-mono", data: { process_runs_target: "percent" } }= "#{percent.round(2)}%"

        -# Progress bar
        %div{ class: "w-full h-3 rounded-full bg-gray-200 overflow-hidden" }
          %div{
            class: "h-3 bg-indigo-500",
            style: "width: #{percent.clamp(0,100)}%",
            data: { process_runs_target: "bar" }
          }

  = render "shared/pagination", collection: @process_runs