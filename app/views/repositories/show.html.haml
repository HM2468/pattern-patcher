-# app/views/repositories/show.html.haml
-# Left repo detail panel (repo_show frame). Style aligned with _repo_dropdown.html.haml.
-# css config located in: app/assets/stylesheets/repository-show.css

- repository = @repository
- return if repository.nil?

- pattern = @current_pattern
- scan_hint = "Scan all files in <strong>#{repository&.name}</strong> with pattern: <strong>#{pattern&.name}</strong>? Or change <a href='#{lexical_patterns_path}' class='underline'>current pattern</a>."

- inner = capture do
  %div{ class: "flex-1 overflow-y-auto" }
    %div{ class: "rounded-2xl border border-indigo-200 overflow-hidden" }
      -# Header
      %div{ class: "bg-indigo-100 px-4 py-3 flex items-start justify-between gap-3" }
        %div{ class: "min-w-0" }
          %div{ class: "text-sm font-semibold text-gray-900 truncate" }
            = repository.name.presence || "—"

          %div{ class: "mt-1 text-xs text-gray-600 font-mono truncate" }
            = repository.current_snapshot&.commit_sha&.slice(0, 8) || "N/A"

        %div{ class: "shrink-0 flex items-center gap-2" }
          - if pattern.present?
            = form_with url: scan_runs_path, method: :post, data: { turbo_frame: "repo_right" }, html: { class: "flex items-center" } do
              = hidden_field_tag :repository_id, repository.id
              %button#bulk_scan_trigger{
                type: "submit",
                class: "icon-button",
                onclick: "return window.PopConfirmLog.open(event, this)",
                data: confirm_scan_tip(tip: 'Repository Scan', title: 'Repository Scan', msg_html: scan_hint)
              }
                = svg_icon("magnifying-glass", class_name: "w-6 h-6")

          = link_to edit_repository_path(repository, repository_id: repository.id),
            class: "icon-button flex items-center",
            data: tooltip_data(tip: "Repository Setting", turbo_frame: "repo_right") do
            = svg_icon("cog-6-tooth", class_name: "w-6 h-6")

      -# Body
      %div{ class: "px-2 py-2 space-y-2" }
        -# Stats cards
        %div{ class: "grid grid-cols-2 gap-2" }
          = link_to repository_files_path(repository_id: repository.id, path_filter: @path_filter.to_s),
            data: { turbo_frame: "repo_right" },
            class: "repo-stat-card" do
            %div.repo-stat-label Files
            %div.repo-stat-value
              %span{ id: dom_id(repository, :file_count) }
                = (@file_count || 0)

          = link_to scan_runs_path(repository_id: repository.id),
            data: { turbo_frame: "repo_right" },
            class: "repo-stat-card" do
            %div.repo-stat-label Scans
            %div.repo-stat-value
              %span{ id: dom_id(repository, :scan_count) }
                = (@scan_count || 0)

        -# Root Path
        - root_path_text = repository.root_path.presence || "—"
        %div.repo-meta-block
          %div.repo-meta-label Root Path
          %div.repo-meta-value{ title: root_path_text }
            = root_path_text

        -# Permitted extensions
        - permitted_text = repository.permitted_ext.presence || "—"
        %div.repo-meta-block
          %div.repo-meta-label Permitted ext
          %div.repo-meta-value{ title: permitted_text }
            = permitted_text

- if turbo_frame_request?
  = turbo_frame_tag "repo_show" do
    = inner
- else
  = inner