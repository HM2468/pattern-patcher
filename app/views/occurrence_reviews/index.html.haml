-# frozen_string_literal: true
-# app/views/occurrence_reviews/index.html.haml

- current_status = (@status.presence || "pending").to_s
- status_options = [["Pending (#{@pending_count})", "pending"], ["Rejected (#{@rejected_count})", "rejected"]]

%div{ class: "h-full overflow-hidden" }
  %div#occurrence_reviews_panel{ class: "flex flex-col h-full overflow-hidden rounded-2xl" }

    -# ===== Fixed Header (NOT scroll) =====
    %div{ class: "bg-indigo-100 text-gray-600 border-b border-gray-100 mx-5 rounded-2xl" }
      %div{ class: "px-6 py-3 flex items-center justify-left gap-3" }
        %div{ class: "flex flex-col items-start text-left leading-tight min-w-0" }
          %div{ class: "text-lg font-semibold text-gray-900" } Reviews

        -# ===== Compact dropdown filter =====
        = form_with url: occurrence_reviews_path, method: :get, local: true, data: { turbo: false }, class: "inline-flex items-center" do
          = hidden_field_tag :page, nil
          %div{ class: "inline-flex items-center gap-2 rounded-md bg-white px-2.5 py-1 shadow-sm ring-1 ring-gray-200 hover:ring-gray-300 focus-within:ring-2 focus-within:ring-indigo-500" }
            %span{ class: "font-mono text-xs text-gray-600" }
            = select_tag :status,
              options_for_select(status_options, current_status),
              class: "font-mono text-xs text-gray-900 bg-transparent border-0 p-0 pr-6 focus:ring-0 focus:outline-none cursor-pointer",
              onchange: "this.form.submit()"

    -# ===== Scroll area: ONLY body scrolls =====
    %div#occ_revs_body_scroll{ class: "pp-scroll-gutter-stable flex-1 overflow-y-auto" }
      %div{ class: "px-6 py-4 space-y-4" }
        - if !defined?(@occurrence_reviews) || @occurrence_reviews.blank?
          %div#occ_revs_empty_state
            .rounded-2xl.bg-gray-50.p-8.shadow-sm
              %div{ class: "text-sm text-gray-600" }
                No Records found.
        - else
          - @occurrence_reviews.each do |occ_rev|
            - diff = @diffs_by_review_id[occ_rev.id]
            - next if diff.nil?
            = render "diff", occ_rev: occ_rev, occ_rev_diff: diff

    -# ===== Fixed Footer Pagination =====
    %div{ class: "sticky bottom-0" }
      - if defined?(@occurrence_reviews) && @occurrence_reviews.respond_to?(:current_page) && @occurrence_reviews.any?
        = render "shared/pagination", collection: @occurrence_reviews